#!/bin/sh
set -e

export AWS_ACCESS_KEY_ID="$INPUT_AWS_ACCESS_KEY_ID"
export AWS_SECRET_ACCESS_KEY="$INPUT_AWS_SECRET_ACCESS_KEY"
export TARGET="$INPUT_TARGET"
export S3_ASSETS_PATH="$INPUT_S3_ASSETS_PATH"
export EC2_SSH_KEY="$INPUT_EC2_SSH_KEY"
export EC2_ADDRESS="$INPUT_EC2_ADDRESS"
export EC2_PATH="$INPUT_EC2_PATH"

# Installing aws cli for deploying to s3.
pip3 install awscli

## Setting up ssh.
eval "$(ssh-agent)"
echo "$EC2_SSH_KEY" | ssh-add -

## Deployment.
echo "Deploying assets to S3."
aws s3 sync $TARGET $S3_ASSETS_PATH \
  --exclude "*.html" --exclude "*.webmanifest" \
  --exclude ".git*" --exclude "README*" --exclude "p/*" \
  --delete --acl public-read

echo "Deploying to EC2."
rsync -avP --delete-excluded \
  --include="*.html" --include="*.webmanifest" \
  --exclude=".git*" --exclude="p" --include="*/" --exclude="*" \
  --rsync-path="mkdir -p $EC2_PATH && rsync" \
  -e "ssh -o StrictHostKeyChecking=no" $TARGET/. $EC2_ADDRESS:$EC2_PATH

echo "getting rid of empty directories generated by rsync."
ssh $EC2_ADDRESS "find $EC2_PATH -type d -empty -delete"
